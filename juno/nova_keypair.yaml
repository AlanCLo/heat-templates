# http://docs.openstack.org/developer/heat/template_guide/hot_spec.html#heat-template-version
heat_template_version: 2014-10-16

# This currently fails on the nectar cloud...

description: >
  NeCTAR Sample Template - A very simple one that just fires up an instance using the OS::Nova::KeyPair
  resource type.


parameters:

  key_name:
    type: string
    description: Name of an existing KeyPair to enable SSH access to instance two
    constraints:
      - custom_constraint: nova.keypair

  instance_type:
    type: string
    description: The NeCTAR flavour the webserver is to run on
    default: m2.xsmall
    constraints:
      - allowed_values: [m2.xsmall, m2.small]
        description:
          Must be a valid NeCTAR flavour, limited to the smaller ones available

  image_id:
    type: string
    description: ID of the image to use for the instance to be created
    default: fc48b5bb-e67d-4e39-b9ba-b6725c8b0c88


resources:

  # This key pair will be deleted when the stack is deleted.
  generated_key_pair:
    # http://docs.openstack.org/developer/heat/template_guide/openstack.html#OS::Nova::KeyPair
    type: OS::Nova::KeyPair
    properties:
      name: generated key pair
      save_private_key: True

  #  Fails with a TypeError: __init__() got an unexpected keyword argument 'retry_after'
  instance_one:
    # http://docs.openstack.org/developer/heat/template_guide/openstack.html#OS::Nova::Server
    type: OS::Nova::Server
    properties:
      key_name: { get_resource: generated_key_pair }
      image: { get_param: image_id }
      flavor: { get_param: instance_type }
      image_update_policy: REPLACE
      user_data_format: RAW

  # This key pair must already exist
  existing_key_pair:
    # http://docs.openstack.org/developer/heat/template_guide/openstack.html#OS::Nova::KeyPair
    type: OS::Nova::KeyPair
    properties:
      name: existing key pair
      public_key:  { get_param: key_name }

  # fails with a BadRequest: Keypair data is invalid: failed to generate fingerprint (HTTP 400) (Request-ID: req-d67861e4-d2c8-469b-ab8a-b5cb97b05893)
  instance_two:
    # http://docs.openstack.org/developer/heat/template_guide/openstack.html#OS::Nova::Server
    type: OS::Nova::Server
    properties:
      key_name: { get_resource: existing_key_pair }
      image: { get_param: image_id }
      flavor: { get_param: instance_type }
      image_update_policy: REPLACE
      user_data_format: RAW

outputs:

  instance_one_access_key:
    description: The private key to access instance one
    value: { get_attr: [generated_key_pair, private_key] }

  instance_one_ip:
    description: The IP address of instance one
    value: { get_attr: [instance_one, first_address] }

  instance_two_ip:
    description: The IP address of instance two
    value: { get_attr: [instance_two, first_address] }